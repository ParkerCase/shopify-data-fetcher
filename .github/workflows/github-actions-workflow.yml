name: Weekly Shopify Report

on:
  schedule:
    # Run every Monday at 7 AM UTC (12 AM Mountain Time in winter, 1 AM in summer)
    - cron: "0 7 * * 1" # Fixed: added space before 1

  # Allow manual trigger from GitHub UI
  workflow_dispatch:
    inputs:
      mode:
        description: "Run mode"
        required: true
        default: "historical-incremental"
        type: choice
        options:
          - weekly
          - historical-incremental
          - historical-full

jobs:
  generate_report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4 # Updated to v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11" # Updated to 3.11

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create .env file
        run: |
          echo "SHOP_NAME=${{ secrets.SHOP_NAME }}" > .env
          echo "API_KEY=${{ secrets.API_KEY }}" >> .env
          echo "PASSWORD=${{ secrets.PASSWORD }}" >> .env
          echo "API_VERSION=${{ secrets.API_VERSION || '2025-04' }}" >> .env
          echo "SPREADSHEET_ID=${{ secrets.SPREADSHEET_ID }}" >> .env

      - name: Create service account key file
        run: |
          echo '${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}' > supple-life-437019-e0-7d94cf81533f.json

      - name: Run Enhanced Shopify Historical Report
        run: |
          # Use historical-incremental for scheduled runs, allow manual mode selection
          if [ "${{ github.event_name }}" = "schedule" ]; then
            MODE="historical-incremental"
          else
            MODE="${{ github.event.inputs.mode || 'historical-incremental' }}"
          fi

          echo "Running in mode: $MODE"
          python shopify_reports.py --mode $MODE

      - name: Upload reports to artifacts
        uses: actions/upload-artifact@v3
        with:
          name: shopify-reports-${{ github.run_id }}
          path: |
            reports/
            spreadsheet_config.txt
          retention-days: 30
          if-no-files-found: warn

      - name: Report completion
        if: success()
        run: |
          echo "âœ… Shopify historical reporting completed successfully!"
          if [ -f "reports/historical_summary.json" ]; then
            echo "ðŸ“Š Summary:"
            cat reports/historical_summary.json
          fi

      - name: Clean up credentials
        if: always()
        run: |
          rm -f supple-life-437019-e0-7d94cf81533f.json
          rm -f .env
